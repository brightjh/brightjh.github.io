<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用Redis的常见问题及解决方案 | THIS BLOG</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/hero.png">
    <meta name="description" content="技术永无止境">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.4552e9ca.js" as="script"><link rel="preload" href="/assets/js/2.245720e2.js" as="script"><link rel="preload" href="/assets/js/15.b87cab04.js" as="script"><link rel="prefetch" href="/assets/js/10.06910aeb.js"><link rel="prefetch" href="/assets/js/11.5b4b7b4c.js"><link rel="prefetch" href="/assets/js/12.155fcbdf.js"><link rel="prefetch" href="/assets/js/13.f9ccf780.js"><link rel="prefetch" href="/assets/js/14.14705abe.js"><link rel="prefetch" href="/assets/js/16.425537b3.js"><link rel="prefetch" href="/assets/js/17.e2638f62.js"><link rel="prefetch" href="/assets/js/18.f0b685d6.js"><link rel="prefetch" href="/assets/js/19.38817534.js"><link rel="prefetch" href="/assets/js/20.2f9cdc7e.js"><link rel="prefetch" href="/assets/js/21.84856f28.js"><link rel="prefetch" href="/assets/js/22.d6e3cb56.js"><link rel="prefetch" href="/assets/js/23.3c4f0a3c.js"><link rel="prefetch" href="/assets/js/24.0a8a564b.js"><link rel="prefetch" href="/assets/js/25.b27ac857.js"><link rel="prefetch" href="/assets/js/26.df7facb1.js"><link rel="prefetch" href="/assets/js/27.8f6aa3ed.js"><link rel="prefetch" href="/assets/js/3.292fd8e0.js"><link rel="prefetch" href="/assets/js/4.abb1af30.js"><link rel="prefetch" href="/assets/js/5.6895aa85.js"><link rel="prefetch" href="/assets/js/6.25c18510.js"><link rel="prefetch" href="/assets/js/7.45169419.js"><link rel="prefetch" href="/assets/js/8.901de557.js"><link rel="prefetch" href="/assets/js/9.da28008d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">THIS BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  高级篇
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具篇
</a></div><div class="nav-item"><a href="/basics/" class="nav-link">
  基础篇
</a></div><div class="nav-item"><a href="https://github.com/brightjh" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  高级篇
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具篇
</a></div><div class="nav-item"><a href="/basics/" class="nav-link">
  基础篇
</a></div><div class="nav-item"><a href="https://github.com/brightjh" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/advanced/" aria-current="page" class="sidebar-link">高级篇</a></li><li><a href="/advanced/Mybatis 入门.html" class="sidebar-link">Mybatis 入门</a></li><li><a href="/advanced/只用Servlet搞定登录与注册.html" class="sidebar-link">只用Servlet搞定登录与注册</a></li><li><a href="/advanced/Spring-让new更优雅.html" class="sidebar-link">Spring-让new更优雅</a></li><li><a href="/advanced/SSM整合.html" class="sidebar-link">SSM整合</a></li><li><a href="/advanced/相见恨晚-SpringBoot.html" class="sidebar-link">相见恨晚-SpringBoot</a></li><li><a href="/advanced/使用Redis的常见问题及解决方案.html" class="active sidebar-link">使用Redis的常见问题及解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#缓存一致性" class="sidebar-link">缓存一致性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#缓存失效策略" class="sidebar-link">缓存失效策略</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#读写时加锁" class="sidebar-link">读写时加锁</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#延迟双删策略" class="sidebar-link">延迟双删策略</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#使用缓存更新消息队列" class="sidebar-link">使用缓存更新消息队列</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#读写分离策略" class="sidebar-link">读写分离策略</a></li></ul></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#缓存穿透" class="sidebar-link">缓存穿透</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#输入合法性校验" class="sidebar-link">输入合法性校验</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#布隆过滤器-bloom-filter" class="sidebar-link">布隆过滤器（Bloom Filter）</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#空值缓存" class="sidebar-link">空值缓存</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#热点数据预加载" class="sidebar-link">热点数据预加载</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#异步查询和缓存更新" class="sidebar-link">异步查询和缓存更新</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#缓存穿透监控和限流" class="sidebar-link">缓存穿透监控和限流</a></li></ul></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#缓存击穿" class="sidebar-link">缓存击穿</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#热点数据预加载-2" class="sidebar-link">热点数据预加载</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#设置短期内不过期" class="sidebar-link">设置短期内不过期</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#互斥锁-mutex-lock" class="sidebar-link">互斥锁（Mutex Lock）</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#布隆过滤器-bloom-filter-2" class="sidebar-link">布隆过滤器（Bloom Filter）</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#失效时间错开" class="sidebar-link">失效时间错开</a></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#缓存穿透监控和限流-2" class="sidebar-link">缓存穿透监控和限流</a></li></ul></li><li class="sidebar-sub-header"><a href="/advanced/使用Redis的常见问题及解决方案.html#结束语" class="sidebar-link">结束语</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用redis的常见问题及解决方案"><a href="#使用redis的常见问题及解决方案" class="header-anchor">#</a> 使用Redis的常见问题及解决方案</h1> <h2 id="缓存一致性"><a href="#缓存一致性" class="header-anchor">#</a> 缓存一致性</h2> <blockquote><p>缓存一致性是指在使用缓存系统时，保证缓存数据与后端数据的一致性。由于缓存系统的读取速度快于后端数据存储系统，如果不进行一致性的处理，就会导致缓存数据与后端数据不一致的情况。</p></blockquote> <h3 id="缓存失效策略"><a href="#缓存失效策略" class="header-anchor">#</a> 缓存失效策略</h3> <p>当后端数据发生变化时，及时使缓存失效。在数据更新或写入操作完成后，通过删除或更新缓存的方式，使缓存数据失效。下次访问时，缓存将重新从后端获取最新的数据，并更新缓存。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">updateShop</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新数据中 确保数据一致性</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;店铺数据有误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 1.更新数据库</span>
        <span class="token function">updateById</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.删除缓存</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="读写时加锁"><a href="#读写时加锁" class="header-anchor">#</a> 读写时加锁</h3> <p>在进行写操作时，先对相关数据进行加锁，防止其他并发操作修改后端数据。当写操作完成后，再释放锁，并更新缓存数据。在读操作时，如果发现缓存数据失效，可以先获取一个读锁，然后从后端获取最新数据并更新缓存，最后释放读锁。这种方式可以保证在写操作期间，其他读写操作无法同时进行，确保了数据的一致性。</p> <h3 id="延迟双删策略"><a href="#延迟双删策略" class="header-anchor">#</a> 延迟双删策略</h3> <p>在进行写操作时，先更新后端数据，然后立即使缓存失效。但在读操作时，如果发现缓存失效，不立即从后端获取最新数据，而是等待一段时间（如几秒钟），再从后端获取最新数据，并更新缓存。这样可以避免多个并发写操作导致缓存与后端数据频繁不一致的问题。</p> <h3 id="使用缓存更新消息队列"><a href="#使用缓存更新消息队列" class="header-anchor">#</a> 使用缓存更新消息队列</h3> <p>当后端数据发生变化时，将变更消息发送到消息队列。缓存系统订阅消息队列，接收到消息后，即使使缓存失效，并从后端获取最新数据进行更新。通过消息队列的方式，可以异步处理缓存的更新，提高系统的性能和并发能力。</p> <h3 id="读写分离策略"><a href="#读写分离策略" class="header-anchor">#</a> 读写分离策略</h3> <p>将读操作和写操作分离，将写操作直接操作后端数据存储系统，而读操作则优先从缓存中获取数据。这种方式可以降低对缓存一致性的要求，因为写操作直接操作后端数据，保证了数据的一致性，而读操作则通过缓存提供较高的性能。</p> <h2 id="缓存穿透"><a href="#缓存穿透" class="header-anchor">#</a> 缓存穿透</h2> <blockquote><p>缓存穿透是指在使用缓存系统时，针对一个不存在于缓存和后端存储系统中的数据进行大量请求查询，导致请求直接访问后端存储系统，而无法从缓存中获取到数据的情况。</p></blockquote> <h3 id="输入合法性校验"><a href="#输入合法性校验" class="header-anchor">#</a> 输入合法性校验</h3> <p>在接收到请求之前，对请求参数进行合法性校验。例如，对请求的参数进行非空、长度或者格式等校验，过滤掉非法请求，避免非法请求直接访问后端存储系统。</p> <h3 id="布隆过滤器-bloom-filter"><a href="#布隆过滤器-bloom-filter" class="header-anchor">#</a> 布隆过滤器（Bloom Filter）</h3> <p>使用布隆过滤器对请求进行预先过滤。布隆过滤器可以快速判断一个元素是否可能存在于集合中，如果布隆过滤器判断请求的数据不存在，可以直接返回缓存不存在的结果，避免对后端存储系统的不必要查询。</p> <h3 id="空值缓存"><a href="#空值缓存" class="header-anchor">#</a> 空值缓存</h3> <p>对于查询结果为空的数据，也将其缓存起来。当下次请求查询同样的数据时，可以直接从缓存中获取到空值，并设置适当的过期时间，以避免大量请求直接访问后端存储系统。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 缓存穿透解决方案</span>
        <span class="token comment">// 1. 从redis中查询缓存</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>

        <span class="token class-name">String</span> shopJson <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 判断是否命中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 命中 返回数据</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 判断是否为空字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 没有命中</span>
        <span class="token comment">// 1.从数据库中查询数据</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.判断数据是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不存在 返回错误,并将空值写入redis，防止缓存穿透</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RandomTTL</span><span class="token punctuation">.</span><span class="token function">getTTL</span><span class="token punctuation">(</span><span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 存在</span>
        <span class="token comment">// 3.将数据写入redis中</span>
        shopJson <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> shopJson<span class="token punctuation">,</span> <span class="token class-name">RandomTTL</span><span class="token punctuation">.</span><span class="token function">getTTL</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_TTL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 返回数据</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><h3 id="热点数据预加载"><a href="#热点数据预加载" class="header-anchor">#</a> 热点数据预加载</h3> <p>预先将热点数据加载到缓存中，即使在缓存穿透时，也能从缓存中获取到数据。这可以通过定时任务或者异步加载的方式实现。</p> <h3 id="异步查询和缓存更新"><a href="#异步查询和缓存更新" class="header-anchor">#</a> 异步查询和缓存更新</h3> <p>在查询数据时，如果发现缓存不存在，可以异步地去后端存储系统查询数据，并将查询到的数据更新到缓存中。在这个过程中，可以使用互斥锁或者分布式锁来确保只有一个请求去查询后端存储系统，其他请求等待结果。</p> <h3 id="缓存穿透监控和限流"><a href="#缓存穿透监控和限流" class="header-anchor">#</a> 缓存穿透监控和限流</h3> <p>监控缓存穿透的情况，并采取限流措施，例如对请求进行限制或者采用缓存请求排队等方式，以保护后端存储系统的稳定性。</p> <h2 id="缓存击穿"><a href="#缓存击穿" class="header-anchor">#</a> 缓存击穿</h2> <blockquote><p>缓存击穿是指在使用缓存系统时，当某个热点数据失效或者缓存中不存在时，大量请求同时涌入后端存储系统，导致存储系统压力剧增，性能下降甚至崩溃的情况。</p></blockquote> <h3 id="热点数据预加载-2"><a href="#热点数据预加载-2" class="header-anchor">#</a> 热点数据预加载</h3> <p>在应用启动时或者缓存失效前，提前将热点数据加载到缓存中，同时设置逻辑过期时间。这样可以避免在热点数据失效时，大量请求直接访问后端存储系统，而是从缓存中获取数据。可以通过定时任务或者异步加载的方式实现预加载。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithLogicExpire</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 缓存击穿 使用逻辑过期时间</span>
        <span class="token comment">// 1. 从redis中查询缓存</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>

        <span class="token class-name">String</span> dataJson <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 判断是否命中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 未命中 返回null</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 命中</span>
        <span class="token comment">// 3. 判断是否逻辑过期</span>
        <span class="token comment">// 获取数据</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 没有逻辑过期 返回数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 逻辑过期，修改缓存 返回过期数据</span>

        <span class="token comment">// 获取互斥锁，开启独立线程</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token constant">LOCK_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 是否获取成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取成功，创建线程，重建缓存</span>
            <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveShopToRedis</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">20L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取失败，返回旧数据</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveShopToRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Long</span> expireSeconds<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置逻辑过期时间 缓存击穿解决方案</span>
    	<span class="token comment">// 数据预热</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置逻辑过期时间</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写入redis</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="设置短期内不过期"><a href="#设置短期内不过期" class="header-anchor">#</a> 设置短期内不过期</h3> <p>针对热点数据，可以将其缓存设置为短期内不过期。当缓存失效时，先从缓存中获取数据，如果获取不到再去后端存储系统查询，并将查询到的数据更新到缓存中。这样可以避免缓存失效时，大量请求直接访问后端存储系统。</p> <h3 id="互斥锁-mutex-lock"><a href="#互斥锁-mutex-lock" class="header-anchor">#</a> 互斥锁（Mutex Lock）</h3> <p>在缓存失效时，通过加锁的方式，只允许一个请求去查询后端存储系统，其他请求等待结果。当第一个请求获取到数据后，更新缓存并释放锁，其他请求再从缓存中获取数据。这样可以避免大量请求同时访问后端存储系统。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 缓存击穿 互斥锁</span>
        <span class="token comment">// 1. 从redis中查询缓存</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>

        <span class="token class-name">String</span> shopJson <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 判断是否命中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 命中 返回数据</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断是否为空字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 没有命中 缓存重建</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token constant">LOCK_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">Shop</span> shop<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.获取互斥锁</span>
            <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获取失败 休眠，重新调用</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 2. 获取成功，再次判断缓存是否重建成功</span>
            <span class="token comment">//  从redis中查询缓存</span>
            shopJson <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  判断是否命中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 命中 返回数据</span>
                <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 判断是否为空字符串</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 缓存没有重建成功，从数据库中查询数据</span>
            shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 模拟重建延时</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 判断数据是否存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 不存在 返回错误,并将空值写入redis，防止缓存穿透</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RandomTTL</span><span class="token punctuation">.</span><span class="token function">getTTL</span><span class="token punctuation">(</span><span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 存在</span>
            <span class="token comment">// 3.将数据写入redis中</span>
            shopJson <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> shopJson<span class="token punctuation">,</span> <span class="token class-name">RandomTTL</span><span class="token punctuation">.</span><span class="token function">getTTL</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_TTL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.释放互斥锁</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. 返回数据</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="布隆过滤器-bloom-filter-2"><a href="#布隆过滤器-bloom-filter-2" class="header-anchor">#</a> 布隆过滤器（Bloom Filter）</h3> <p>在查询缓存之前，先使用布隆过滤器进行判断。布隆过滤器是一种快速的、内存占用较小的数据结构，用于判断一个元素是否可能存在于集合中。如果布隆过滤器判断元素不存在，可以直接返回缓存不存在，避免不必要的查询后端存储系统。</p> <h3 id="失效时间错开"><a href="#失效时间错开" class="header-anchor">#</a> 失效时间错开</h3> <p>针对大量缓存同时失效的场景，可以在设置缓存失效时间时，加上一个随机的时间偏移。这样每个缓存的失效时间不完全相同，可以分散请求对后端存储系统的压力。</p> <h3 id="缓存穿透监控和限流-2"><a href="#缓存穿透监控和限流-2" class="header-anchor">#</a> 缓存穿透监控和限流</h3> <p>对于频繁发生缓存击穿的情况，可以监控缓存失效的频率，并进行限流措施，例如对请求进行限制或者采用缓存请求排队等方式，以保护后端存储系统的稳定性。</p> <h2 id="结束语"><a href="#结束语" class="header-anchor">#</a> 结束语</h2> <blockquote><p>鱼与熊掌不可兼得</p></blockquote> <blockquote><p>想要Redis或者其他缓存机制的快，就必须要解决缓存所带来的一系列问题，“欲戴皇冠，必承其重”。</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/相见恨晚-SpringBoot.html" class="prev">
        相见恨晚-SpringBoot
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4552e9ca.js" defer></script><script src="/assets/js/2.245720e2.js" defer></script><script src="/assets/js/15.b87cab04.js" defer></script>
  </body>
</html>
